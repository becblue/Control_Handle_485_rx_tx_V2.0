# STM32通信控制项目

## ? 项目简介
这是一个基于STM32F103系列单片机开发的工业通信控制系统，采用主从架构设计，实现了数据采集、IO控制和模拟量输出等功能。系统支持双向通信，可配置为发送端或接收端，通过RS485实现可靠的数据传输。

## ? 主要特性
- 双工作模式：发送/接收模式可配置
- 实时数据采集与传输（50ms周期）
- 数字量IO控制（支持多路IO）
- 模拟量采集与输出
- CRC16校验保护机制
- 定时器精确控制

## ?? 开发环境
- IDE: Keil MDK 5.x
- 编译器: ARMCC V5
- STM32标准外设库: STM32F10x_StdPeriph_Lib_V3.5.0
- 操作系统: Windows 10/11

## ? 硬件资源
- MCU: STM32F103系列
- 晶振: 8MHz外部晶振
- 通信: UART1 (115200, 8N1)
- 定时器: TIM2（1ms基础定时）
- GPIO: 数字输入/输出
- ADC: 模拟量采集
- DAC: 模拟量输出

## ? 功能模块
### 1. 系统初始化 (Bsp)
```c
void Bsp_Init(void)
{
    // 系统时钟配置
    // 外设初始化
    // 中断优先级配置
}
```

### 2. 通信模块 (STM32_Uart1)
```c
void Usart1_Init(uint32_t bound)
{
    // UART1初始化（115200, 8N1）
    // RS485方向控制
    // 接收中断配置
}
```

### 3. 定时器模块 (Timer2)
```c
void TIM2_Init(uint16_t arr, uint16_t psc)
{
    // 基础定时单位：1ms
    // 用于通信超时检测
    // 按键扫描定时
}
```

### 4. IO应用模块 (IOApp)
```c
void IO_App_Init(void)
{
    // IO端口初始化
    // 输入输出配置
}
```

### 5. 模拟量处理模块
```c
// 发送模式
void AD_App_Init(void)
{
    // ADC初始化
    // 采样配置
}

// 接收模式
void AO_App_Init(void)
{
    // DAC初始化
    // 输出配置
}
```

## ? 通信协议
### 数据帧格式

## 项目概述
这是一个基于STM32单片机的通信控制项目，支持数据采集和控制功能。项目包含两种工作模式：发送模式(SEND)和接收模式。

### 主要功能
- 数据采集和发送
- IO控制
- 模拟量输出
- UART通信
- 定时器功能

## 硬件要求
- MCU: STM32系列单片机
- 通信接口: UART1 (115200波特率)
- 定时器: TIM2
- IO接口
- AD采样接口
- 模拟输出接口

## 软件架构

### 核心模块
1. **通信模块 (STM32_Uart1)**
   - 负责UART1通信
   - 支持115200波特率
   - 包含数据发送和接收功能

2. **定时器模块 (timer2)**
   - 基于TIM2
   - 提供定时功能
   - 定时精度1ms

3. **IO控制模块 (IO/IOApp)**
   - 管理IO输入输出
   - 支持IO状态读取和设置

4. **AD采样模块 (ADApp)**
   - 用于模拟量采集
   - 仅在发送模式下启用

5. **模拟输出模块 (AOApp)**
   - 处理模拟量输出
   - 仅在接收模式下启用

6. **数据处理模块**
   - 包含平均值计算(Average)
   - CRC校验功能(crc)

### 通信协议
数据帧格式：
- 帧头: 0xAA
- 数据长度: 14字节
- CRC校验: Modbus CRC-16

## 工作模式

### 发送模式 (DEVICE_MODE_SEND)
1. 定时采集数据
2. 打包IO状态和AD采样值
3. 添加CRC校验
4. 通过UART发送数据包

### 接收模式
1. 接收数据并进行CRC校验
2. 更新IO输出状态
3. 设置模拟输出值
4. 返回确认信息
   - 接收成功后返回ACK确认帧（帧头0xAA + 状态码0x01 + CRC校验）
   - 接收失败返回NACK否认帧（帧头0xAA + 状态码0xFF + 错误类型 + CRC校验）
   - 确认信息在接收到数据后10ms内发送
   - 状态反馈包含本地IO输入状态，便于发送端确认控制效果

## ? 目录结构

```
STM32_V1.1_修改逻辑/
├── ? Bsp/                     # 硬件抽象层 (BSP)
│   ├── ? Bsp.h/.c             # 系统基础初始化
│   ├── ? AD.h/.C              # ADC模拟量采集驱动
│   ├── ? AO.h/.c              # DAC模拟量输出驱动
│   ├── ? IO.h/.c              # GPIO基础配置
│   ├── ? Key.h/.c             # 按键扫描处理
│   └── ? STM32_Uart1.h/.c     # UART1串口驱动
│
├── ? User/                    # 用户应用层
│   ├── ? inc/                 # 头文件目录
│   │   ├── ? object/          # 对象文件
│   │   │   └── ? Timer.h      # 定时器对象定义
│   │   ├── ? ADApp.h          # AD应用层接口
│   │   ├── ? AOApp.h          # AO应用层接口
│   │   ├── ? Average.h        # 平均值计算
│   │   ├── ? BSP_10X_IT.H     # 中断处理
│   │   ├── ? crc.h            # CRC校验算法
│   │   ├── ? includes.h       # 公共头文件
│   │   ├── ? IOApp.h          # IO应用层接口
│   │   ├── ? stm32f10x_*.h    # STM32配置文件
│   │   └── ? timer2.h         # TIM2定时器
│   │
│   └── ? scr/                 # 源代码目录
│       ├── ? object/          # 对象源文件
│       │   └── ? Timer.c      # 定时器对象实现
│       ├── ? main.c           # 主程序入口 ?
│       ├── ? ADApp.c          # AD应用层实现
│       ├── ? AOApp.c          # AO应用层实现
│       ├── ? Average.c        # 平均值计算实现
│       ├── ? crc.c            # CRC校验实现
│       ├── ? IOApp.c          # IO应用层实现
│       ├── ? stm32f10x_it.c   # 中断服务函数
│       └── ? timer2.c         # TIM2定时器实现
│
├── ? Lib/                     # STM32标准库
│   ├── ? CMSIS/               # ARM CMSIS标准接口
│   └── ? STM32F10x_StdPeriph_Driver/ # STM32外设驱动库
│
├── ? Proj/                    # Keil工程文件
│   ├── ? sl8629V10.uvprojx    # Keil工程配置
│   └── ? Objects/             # 编译输出文件
│
└── ? README.md                # 项目说明文档
```

## ? 快速开始

### 编译步骤
1. 使用Keil MDK 5.x打开 `Proj/sl8629V10.uvprojx`
2. 选择目标芯片：STM32F103RC
3. 编译项目：Project → Build Target
4. 下载程序到目标板

### 工作模式配置
在 `User/inc/IOApp.h` 中修改设备模式：
```c
#define DEVICE_MODE_SEND	0    // 发送模式
#define DEVICE_MODE_RECV	1    // 接收模式
#define DEVICE_MODE		DEVICE_MODE_RECV  // 当前模式
```

## ? 技术规格

### 通信参数
- **波特率**: 115200 bps
- **数据位**: 8位
- **停止位**: 1位
- **校验位**: 无
- **流控**: 无

### 定时器配置
- **TIM2**: 1ms基础定时，用于按键扫描和通信超时
- **系统定时**: 基于SysTick，72MHz系统时钟

### IO配置
- **数字输入**: 12路GPIO输入（上拉输入）
- **数字输出**: 24路GPIO输出（推挽输出）
- **模拟输入**: 2路ADC采集（PA1, PA2）
- **模拟输出**: 2路DAC输出（通过SPI DAC芯片）

## ? 优化特性

### 代码优化
- ? 移除未使用的模块，减少代码体积
- ? 简化项目结构，提高可维护性
- ? 保留核心功能，确保系统稳定

### 性能优化
- ? 50ms数据采集周期
- ? 1ms精度定时控制
- ? 硬件CRC校验
- ? DMA数据传输

---

**注意**: 此项目已经过代码清理，移除了未使用的复杂功能模块（如空调控制、存储管理、多协议通信等），专注于核心的数据采集和IO控制功能。